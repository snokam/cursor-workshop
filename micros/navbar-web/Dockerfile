# Autogenerated by @snokam/iac
# DO NOT EDIT THIS FILE

# Use Node.js 22 LTS as base image
FROM public.ecr.aws/docker/library/node:22-alpine AS builder

# Install system dependencies and pnpm
RUN apk add --no-cache libc6-compat 
RUN npm install -g pnpm@latest

WORKDIR /app

# Copy source code and build
COPY . .

# Change to project directory if specified (for monorepos), otherwise stay at root
WORKDIR /app/micros/navbar

# Install dependencies at workspace root (handles monorepos correctly)
RUN pnpm install --frozen-lockfile

# Set build environment variables
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS="--max-old-space-size=8192"
ENV NODE_ENV=production

# Build the application (will use .env file if present)
RUN pnpm run build

# Production image - minimal runtime
FROM public.ecr.aws/docker/library/node:22-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy standalone build maintaining directory structure for monorepos
COPY --from=builder --chown=nextjs:nodejs /app/micros/navbar/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/micros/navbar/.next/static ./micros/navbar/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/micros/navbar/public ./micros/navbar/public

USER nextjs

EXPOSE 80
ENV PORT=80

# Start the Next.js standalone application
CMD ["node", "micros/navbar/server.js"]